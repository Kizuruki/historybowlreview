<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>History Bowl Study Program ‚Äî Single-file</title>
<style>
    /* --------- Visual styles (kept from your original, adjusted slightly) ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        min-height:100vh;color:#222;padding:24px;
    }
    .container{max-width:1100px;margin:0 auto;background:transparent}
    .header{text-align:center;color:#fff;margin-bottom:20px}
    .header h1{font-size:2.2rem;text-shadow:2px 2px 4px rgba(0,0,0,0.25)}
    .menu{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:16px}
    .card{background:rgba(255,255,255,0.95);padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.12);cursor:pointer}
    .card h3{color:#5a67d8;margin-bottom:8px}
    .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#6c757d;margin-left:8px}
    .game-area{display:none;margin-bottom:18px}
    .scoreboard{display:flex;gap:12px;align-items:center;background:#f8f9fa;padding:12px;border-radius:10px;margin-bottom:12px}
    .team-score{flex:1;text-align:center;padding:8px;background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .team-name{font-weight:700;color:#5a67d8}
    .score{font-size:1.6rem;font-weight:800}
    .question-area{background:#f8f9fa;padding:16px;border-left:6px solid #5a67d8;border-radius:8px;min-height:110px}
    .question-text{font-size:1.05rem;color:#2d3748;min-height:62px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .buzzer-btn{background:#e53e3e;color:white;padding:12px 22px;border-radius:999px;border:none;font-size:16px;font-weight:700;cursor:pointer}
    .buzzer-btn:disabled{background:#a0aec0;cursor:not-allowed}
    .answer-input{padding:10px;border-radius:8px;border:2px solid #e2e8f0;font-size:15px;width:100%;max-width:520px}
    .feedback{margin-top:10px;padding:12px;border-radius:8px;font-weight:700;display:none}
    .feedback.correct{background:#c6f6d5;color:#22543d;border:1px solid #9ae6b4}
    .feedback.incorrect{background:#fed7d7;color:#742a2a;border:1px solid #fc8181}
    .hidden{display:none}
    .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
    .category-btn{padding:12px;border-radius:8px;background:white;border:1px solid #e2e8f0;cursor:pointer;text-align:center}
    .category-btn.selected{background:#5a67d8;color:white;border-color:#5a67d8}
    .admin-panel{display:none;background:rgba(255,255,255,0.95);padding:16px;border-radius:12px;margin-top:12px}
    .question-list{background:white;padding:12px;border-radius:8px;max-height:260px;overflow:auto;margin-top:8px}
    .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .leaderboard{background:#fff;padding:12px;border-radius:8px;margin-top:12px;max-height:260px;overflow:auto}
    .small{font-size:0.9rem;color:#444}
    .muted{color:#666;font-size:0.9rem}
    footer{margin-top:18px;color:#fff;text-align:center;font-size:0.9rem}
    @media (max-width:700px){.scoreboard{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìö History Bowl Study Program</h1>
        <p class="small">Single-team practice + Full-game simulation ‚Äî single-file</p>
    </div>

    <!-- Main menu -->
    <div id="mainMenu" class="menu">
        <div class="card" onclick="openPracticeMode()">
            <h3>üéØ Practice Mode</h3>
            <p class="muted">Pick a quarter to target specific formats and question types.</p>
            <div style="margin-top:10px"><button class="btn">Start Practice</button></div>
        </div>

        <div class="card" onclick="startFullGameFromMenu()">
            <h3>üèÜ Full Game Simulation</h3>
            <p class="muted">Play a full match (Q1‚ÜíQ4) with official scoring & bonuses.</p>
            <div style="margin-top:10px"><button class="btn">Start Full Game</button></div>
        </div>

        <div class="card" onclick="showQuestionManager()">
            <h3>‚ûï Question Manager</h3>
            <p class="muted">Edit the embedded question arrays in this file (instructions below).</p>
            <div style="margin-top:10px"><button class="btn">Manage Questions</button></div>
        </div>

        <div class="card" onclick="showLeaderboardPanel()">
            <h3>üèÖ Local Leaderboard</h3>
            <p class="muted">Your browser stores every saved attempt. Sorted by weighted score.</p>
            <div style="margin-top:10px"><button class="btn">View Leaderboard</button></div>
        </div>
    </div>

    <!-- Game area -->
    <div id="gameArea" class="game-area">
        <div class="scoreboard">
            <div class="team-score">
                <div class="team-name">Player</div>
                <div class="score" id="rawScore">0</div>
                <div class="small muted">Raw points</div>
            </div>
            <div style="text-align:center">
                <div class="small">Quarter</div>
                <div id="quarterDisplay" style="font-weight:700">1</div>
                <div id="questionCounter" class="small muted">Q 0 / 0</div>
            </div>
            <div class="team-score">
                <div class="team-name">Weighted</div>
                <div class="score" id="weightedScore">0</div>
                <div class="small muted">Weighted (multiplier)</div>
            </div>
        </div>
        <div style="text-align:center">
           <div class="small">Timer</div>
            <div id="timerDisplay" style="font-weight:700">--</div>
        </div>

        <div class="question-area">
            <div id="questionText" class="question-text">Click "Next Question" to begin.</div>
        </div>

        <div class="controls">
            <button id="buzzerBtn" class="buzzer-btn" onclick="buzz()" disabled>üîî BUZZ</button>
            <button class="btn" onclick="nextQuestion()">Next Question</button>
            <button class="btn secondary" onclick="showAnswer()">Show Answer</button>

            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                <div class="small muted">Mode:</div>
                <div id="modeDisplay" style="font-weight:700">Practice</div>
            </div>
        </div>

        <div class="controls-row">
            <input id="answerInput" class="answer-input" placeholder="Type answer and press Enter or Submit..." disabled>
            <button class="btn" onclick="submitAnswer()">Submit</button>
            <div id="multiplierDisplay" class="small muted">Multiplier: √ó1</div>
        </div>

        <div id="feedback" class="feedback"></div>

        <!-- Q3 category selection area (for practice or full game behavior) -->
        <div id="categorySelection" class="categories hidden"></div>

        <!-- Controls to go back or reset -->
        <div class="controls-row" style="margin-top:12px">
            <button class="btn secondary" onclick="backToMenu()">Back to Menu</button>
            <button class="btn" onclick="resetGame()">Reset Game</button>
        </div>
    </div>

    <!-- Admin / Question Manager (simple) -->
    <div id="adminPanel" class="admin-panel">
        <h3>Question Manager ‚Äî Quick Edit</h3>
        <p class="small muted">This page displays the active question arrays and allows quick import/export. For a permanent change, edit the <code>QUESTIONS</code> section inside this HTML file (search for the comment "=== QUESTIONS ===").</p>

        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn" onclick="exportQuestions()">Export JSON</button>
            <button class="btn" onclick="importQuestions()">Import JSON</button>
            <button class="btn secondary" onclick="backToMenu()">Back to Menu</button>
        </div>

        <div class="question-list" id="questionsDisplay"></div>
    </div>

    <!-- Leaderboard panel -->
    <div id="leaderboardPanel" class="admin-panel hidden">
        <h3>Local Leaderboard (all attempts)</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <button class="btn" onclick="clearLeaderboard()">Clear Leaderboard</button>
            <button class="btn secondary" onclick="backToMenu()">Back to Menu</button>
        </div>
        <div class="leaderboard" id="leaderboardList"></div>
    </div>

    <footer>
        <div class="small">Notes: No point deductions for wrong answers (per your rules). Q2 bonus is shown after a correct tossup. Q3 category sweep bonus (+20) is applied when all questions in that category are answered correctly.</div>
    </footer>
</div>

<script>
/* ================================================================
   === QUESTIONS ===
   Edit these arrays to add or change questions. Keep everything
   in this single file (per your request). The structure:

   - quarter1Questions: array of { question, answer }
     8 tossups recommended.

   - quarter2Questions: array of { tossup: {question, answer}, bonus: {question, answer} }
     8 tossups recommended; include a bonus field for questions with bonuses.

   - quarter3Categories: array of { category: "Name", questions: [ {question, answer}, ... ] }
     Each category should have 6 questions in tournament format.

   - quarter4Questions: array of { parts: [ {text, answer}, {text, answer}, {text, answer} ] }
     Each entry is one pyramid tossup (3 parts). For single-team practice this will act as a standard question.
   ================================================================ */
function shuffle(array){
    for (let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i+1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

const QUESTIONS = {
    q1: [
        { question: "This ancient wonder of the world was located in Alexandria and was destroyed by earthquakes. Name this lighthouse.", answer: "Lighthouse of Alexandria" },
        { question: "This Roman general crossed the Rubicon River in 49 BCE, starting a civil war. Name him.", answer: "Julius Caesar" },
        { question: "This 1803 purchase doubled the size of the United States. Name this acquisition.", answer: "Louisiana Purchase" },
        { question: "This battle in 1066 saw the Norman conquest of England. Name this battle.", answer: "Battle of Hastings" },
        { question: "This ancient Greek playwright wrote 'Oedipus Rex'. Name this playwright.", answer: "Sophocles" },
        { question: "This conflict began in 1914 with the assassination of Archduke Franz Ferdinand. Name the war.", answer: "World War I" },
        { question: "This document, signed in 1215, limited the power of the English monarchy. Name it.", answer: "Magna Carta" },
        { question: "This trade route connected China to the Mediterranean across Central Asia. Name it.", answer: "Silk Road" }
    ],

    q2: [
        { tossup: { question: "This president purchased Louisiana from France in 1803.", answer: "Thomas Jefferson" }, bonus: { question: "Name the two explorers Jefferson sent to map this new territory.", answer: "Lewis and Clark" } },
        { tossup: { question: "This Egyptian queen allied herself with Julius Caesar and later Mark Antony.", answer: "Cleopatra VII" }, bonus: { question: "Name the battle where Octavian defeated Antony and Cleopatra in 31 BCE.", answer: "Battle of Actium" } },
        { tossup: { question: "This English king had six wives and initiated the English Reformation.", answer: "Henry VIII" }, bonus: { question: "Name the daughter of Henry VIII who reigned after Edward VI and was nicknamed 'Bloody'.", answer: "Mary I" } },
        { tossup: { question: "This 19th-century German chancellor unified Germany after the Franco-Prussian War.", answer: "Otto von Bismarck" }, bonus: { question: "Name the 1871 proclamation city where the German Empire was declared.", answer: "Versailles" } }
    ],

    q3: [
        {
            category: "Ancient Civilizations",
            questions: [
                { question: "This river was crucial to Egyptian civilization.", answer: "Nile River" },
                { question: "This code was created by a Babylonian king.", answer: "Code of Hammurabi" },
                { question: "This city-state was known for its military culture.", answer: "Sparta" },
                { question: "This structure was built to keep out northern invaders in China.", answer: "Great Wall of China" },
                { question: "This empire was founded by Cyrus the Great.", answer: "Persian Empire" },
                { question: "This wonder of the world was located in Babylon.", answer: "Hanging Gardens of Babylon" }
            ]
        },
        {
            category: "American History",
            questions: [
                { question: "This document was signed in 1776.", answer: "Declaration of Independence" },
                { question: "This war lasted from 1861 to 1865.", answer: "American Civil War" },
                { question: "This president was assassinated in 1865.", answer: "Abraham Lincoln" },
                { question: "This purchase was made from Russia in 1867.", answer: "Alaska Purchase" },
                { question: "This amendment abolished slavery.", answer: "13th Amendment" },
                { question: "This trail was used by pioneers moving west.", answer: "Oregon Trail" }
            ]
        },
        {
            category: "World Wars",
            questions: [
                { question: "This event started World War I in 1914.", answer: "Assassination of Archduke Franz Ferdinand" },
                { question: "This battle was the longest of World War I.", answer: "Battle of Verdun" },
                { question: "This country invaded Poland in 1939.", answer: "Germany" },
                { question: "This attack brought the US into World War II.", answer: "Pearl Harbor" },
                { question: "This operation was the D-Day invasion.", answer: "Operation Overlord" },
                { question: "This city was the first target of an atomic bomb.", answer: "Hiroshima" }
            ]
        }
    ],

    q4: [
        {
            parts: [
                { text: "This 19th-century American novelist wrote an epic tale of obsession and the sea (30 pts).", answer: "Herman Melville" },
                { text: "This author wrote 'Moby-*****', which features Captain Ahab (20 pts).", answer: "Herman Melville" },
                { text: "Name the author of 'Billy Budd' as well (10 pts).", answer: "Herman Melville" }
            ]
        },
        {
            parts: [
                { text: "This Renaissance artist painted the ceiling of the Sistine Chapel (30 pts).", answer: "Michelangelo" },
                { text: "He was also a sculptor who created the statue of David (20 pts).", answer: "Michelangelo" },
                { text: "Name this Italian master who carved 'Piet√†' (10 pts).", answer: "Michelangelo" }
            ]
        }
    ]
};

/* ================================================================
   END OF QUESTIONS
   You can add or remove objects in the arrays above. Keep the
   structures consistent. See the inline example comments for
   guidance.
   ================================================================ */

/* ------------------ Game state & helpers ------------------ */
let gameState = {
    mode: "practice", // 'practice' or 'full'
    currentQuarter: 1,
    currentQuestionIndex: -1, // index in the quarter array (0-based)
    rawScore: 0,
    weightedScore: 0,
    q4partIndex: 0,
    readingInterval: null,
    readingCharIndex: 0,
    currentQuestionText: "",
    currentAnswer: "",
    currentBonus: null,
    buzzed: false,
    multiplier: 1,
    // For Q3 category: index of selected category and how many answered correct in it
    q3selectedCategory: null,
    q3categoryProgress: 0,
    q3categoryCorrectCount: 0,
    // track Q3 sweep possibility
    q3Swept: false,
    // track Q4 part index if needed (we'll handle by percent read)
    lastActionTimestamp: null
};

const $ = id => document.getElementById(id);

function readQ4Part() {
    if (!gameState.currentQ4Parts) return;
    const partIndex = gameState.q4partIndex;
    const partText = gameState.currentQ4Parts[partIndex];
    gameState.currentQuestionText = partText;
    gameState.readingCharIndex = 0;
    $('questionText').textContent = "";
    gameState.readingInterval = setInterval(() => {
        if (gameState.readingCharIndex < partText.length && !gameState.buzzed) {
            $('questionText').textContent += partText[gameState.readingCharIndex];
            gameState.readingCharIndex++;
        } else {
            clearInterval(gameState.readingInterval);
            gameState.readingInterval = null;
            // If not buzzed, move to next part
            if (!gameState.buzzed && partIndex < gameState.currentQ4Parts.length - 1) {
                gameState.q4partIndex++;
                setTimeout(readQ4Part, 800); // brief pause before next part
            } else if (!gameState.buzzed) {
                // End of last part: allow buzz for a few seconds if needed
                let postReadTime = 5;
                $('timerDisplay').textContent = `Buzz: ${postReadTime}`;
                gameState.postReadTimer = setInterval(() => {
                    postReadTime--;
                    $('timerDisplay').textContent = `Buzz: ${postReadTime}`;
                    if (postReadTime <= 0) {
                        clearInterval(gameState.postReadTimer);
                        $('buzzerBtn').disabled = true;
                        $('timerDisplay').textContent = "--";
                    }
                }, 1000);
            }
        }
    }, 30);
}

/* ------------------ UI helpers ------------------ */
function updateScoreDisplays(){
    $('rawScore').textContent = gameState.rawScore;
    $('weightedScore').textContent = gameState.weightedScore;
    $('multiplierDisplay').textContent = `Multiplier: √ó${gameState.multiplier}`;
    $('quarterDisplay').textContent = gameState.currentQuarter;
}

function setFeedback(text, ok=true){
    const f = $('feedback');
    f.textContent = text;
    f.classList.remove('correct','incorrect');
    f.classList.add(ok ? 'correct' : 'incorrect');
    f.style.display = 'block';
    setTimeout(()=>{ f.style.display = 'none'; }, 4000);
}

function clearFeedback(){
    const f = $('feedback');
    f.style.display = 'none';
}

/* ------------------ Navigation / menu ------------------ */
function backToMenu(){
    clearAllTimers();
    $('gameArea').style.display = 'none';
    $('adminPanel').style.display = 'none';
    $('leaderboardPanel').style.display = 'none';
    $('mainMenu').style.display = 'grid';
    // reset some state
    gameState.mode = 'practice';
    $('modeDisplay').textContent = 'Practice';
}

function openPracticeMode(){
    resetGame();
    gameState.mode = 'practice';
    $('modeDisplay').textContent = 'Practice';
    $('mainMenu').style.display = 'none';
    $('gameArea').style.display = 'block';
    // allow picking quarter manually before Next Question
    showPracticeQuarterOptions();
}

function startFullGameFromMenu(){
    resetGame();
    gameState.mode = 'full';
    $('modeDisplay').textContent = 'Full Game';
    $('mainMenu').style.display = 'none';
    $('gameArea').style.display = 'block';
    // begin game
    startGame();
}

function showQuestionManager(){
    clearAllTimers();
    $('mainMenu').style.display = 'none';
    $('gameArea').style.display = 'none';
    $('leaderboardPanel').style.display = 'none';
    $('adminPanel').style.display = 'block';
    renderQuestionsDisplay();
}

function showLeaderboardPanel(){
    clearAllTimers();
    $('mainMenu').style.display = 'none';
    $('gameArea').style.display = 'none';
    $('adminPanel').style.display = 'none';
    $('leaderboardPanel').style.display = 'block';
    renderLeaderboard();
}

/* ------------------ Timer/Reading helpers ------------------ */
function clearAllTimers(){
    if (gameState.readingInterval){ clearInterval(gameState.readingInterval); gameState.readingInterval = null; }
    gameState.readingCharIndex = 0;
}

function startGame(){
    resetGame();
    gameState.mode = 'full';
    $('modeDisplay').textContent = 'Full Game';
    // start at Q1
    gameState.currentQuarter = 1;
    gameState.currentQuestionIndex = -1;
    updateScoreDisplays();
    nextQuestion();
}

/* ------------------ Reset ------------------ */
function resetGame(){
    clearAllTimers();
    gameState = {
        mode: gameState.mode || 'practice',
        currentQuarter: 1,
        currentQuestionIndex: -1,
        rawScore: 0,
        weightedScore: 0,
        readingInterval: null,
        readingCharIndex: 0,
        currentQuestionText: "",
        currentAnswer: "",
        currentBonus: null,
        buzzed: false,
        multiplier: 1,
        q3selectedCategory: null,
        q3categoryProgress: 0,
        q3categoryCorrectCount: 0,
        q3Swept: false,
        lastActionTimestamp: null,
        activeQ1: shuffle([...QUESTIONS.q1]),
        activeQ2: shuffle([...QUESTIONS.q2]),
        activeQ3: shuffle([...QUESTIONS.q3]),
        activeQ4: shuffle([...QUESTIONS.q4])
    };
    $('questionText').textContent = "Click 'Next Question' to start!";
    $('buzzerBtn').disabled = true;
    $('answerInput').disabled = true;
    $('answerInput').value = '';
    $('multiplierDisplay').textContent = 'Multiplier: √ó1';
    $('questionCounter').textContent = 'Q 0 / 0';
    $('timerDisplay').textContent = '--';
    updateScoreDisplays();
    clearFeedback();
}

/* ------------------ Question selection helpers ------------------ */
function getCurrentQuarterArray(){
    if (gameState.currentQuarter === 1) return gameState.activeQ1;
    if (gameState.currentQuarter === 2) return gameState.activeQ2;
    if (gameState.currentQuarter === 3) return gameState.activeQ3;
    if (gameState.currentQuarter === 4) return gameState.activeQ4;
    return [];
}

function incrementQuestionIndex(){
    // Move to next question index for the current quarter.
    const arr = getCurrentQuarterArray();
    if (gameState.currentQuarter === 3 && gameState.q3selectedCategory !== null){
        // inside a category: we use q3categoryProgress as index (0..5)
        gameState.q3categoryProgress++;
        // If category done, clear selection to force next selection logic
        const cat = QUESTIONS.q3[gameState.q3selectedCategory];
        if (gameState.q3categoryProgress >= (cat.questions.length || 0)){
            gameState.q3selectedCategory = null;
            gameState.q3categoryProgress = 0;
            // If in full game, move to next quarter after both categories answered? For single-player we just continue.
        }
    } else {
        gameState.currentQuestionIndex++;
    }
}

/* ------------------ Start Next Question ------------------ */
function nextQuestion(){
    clearAllTimers();
    clearFeedback();

    // If practice mode and quarter not selected, prompt category options or set currentQuarter to last selected
    if (gameState.mode === 'practice' && !gameState.practiceQuarterSelected){
        // show quarter picker UI (quick)
        const choice = prompt("Enter practice quarter (1,2,3,4) or 'q' to cancel:", "1");
        if (!choice || choice.toLowerCase() === 'q') return;
        const q = parseInt(choice);
        if (![1,2,3,4].includes(q)){ alert("Invalid quarter"); return; }
        gameState.currentQuarter = q;
        gameState.practiceQuarterSelected = true;
        // reset indices
        gameState.currentQuestionIndex = -1;
        gameState.q3selectedCategory = null;
        gameState.q3categoryProgress = 0;
    }

    // Determine quarter arrays
    const quarterArr = getCurrentQuarterArray();

    // For Q3: if a category hasn't been selected, show category selection (if in practice or if in full-game this happens at category round)
    if (gameState.currentQuarter === 3 && gameState.q3selectedCategory === null){
        // Show category buttons if not selected
        showCategorySelection();
        return;
    }

    // Determine next question index and existence
    if (gameState.currentQuarter === 3 && gameState.q3selectedCategory !== null){
        const cat = QUESTIONS.q3[gameState.q3selectedCategory];
        if (!cat || !cat.questions || cat.questions.length === 0){
            $('questionText').textContent = "No questions in this category.";
            return;
        }
        // If we've answered all in this category, end category and if in full game move on
        if (gameState.q3categoryProgress >= cat.questions.length){
            // finished category
            if (gameState.mode === 'full'){
                // move to next quarter
                gameState.currentQuarter++;
                gameState.currentQuestionIndex = -1;
                gameState.q3selectedCategory = null;
                gameState.q3categoryProgress = 0;
                nextQuestion();
                return;
            } else {
                // practice mode: let user pick another category (or finish)
                gameState.q3selectedCategory = null;
                showCategorySelection();
                return;
            }
        }
    } else {
        // Non-Q3: increment index
        gameState.currentQuestionIndex++;
        // If we ran out of questions in the quarter...
        const arrLen = (gameState.currentQuarter === 3) ? QUESTIONS.q3.length : quarterArr.length;
        // For Q1,Q2,Q4 check bounds
        let arrLength;
        if (gameState.currentQuarter === 1) arrLength = QUESTIONS.q1.length;
        else if (gameState.currentQuarter === 2) arrLength = QUESTIONS.q2.length;
        else if (gameState.currentQuarter === 4) arrLength = QUESTIONS.q4.length;
        else arrLength = 0;

        if (gameState.currentQuarter !== 3 && gameState.currentQuestionIndex >= arrLength){
            // end of quarter
            if (gameState.mode === 'full'){
                if (gameState.currentQuarter < 4){
                    gameState.currentQuarter++;
                    gameState.currentQuestionIndex = -1;
                    nextQuestion();
                    return;
                } else {
                    // end of full game
                    finishGame();
                    return;
                }
            } else {
                // practice: we've exhausted questions
                alert(`No more questions in Quarter ${gameState.currentQuarter}. You can edit the QUESTIONS section to add more.`);
                gameState.currentQuestionIndex = arrLength - 1;
                return;
            }
        }
    }

    // Ready UI for a new question
    $('buzzerBtn').disabled = false;
    $('answerInput').disabled = true;
    $('answerInput').value = '';
    $('questionText').textContent = 'Get ready...';
    $('questionCounter').textContent = computeQuestionCounterText();

    // Small delay to simulate moderator prep then start reading
    setTimeout(()=> startReading(), 800);
}

/* ------------------ Category selection for Q3 ------------------ */
function showCategorySelection(){
    const container = $('categorySelection');
    container.innerHTML = `<h4 style="width:100%">Select a Category</h4>`;
    container.classList.remove('hidden');
    QUESTIONS.q3.forEach((cat, idx) => {
        const btn = document.createElement('div');
        btn.className = 'category-btn';
        btn.textContent = `${cat.category} (${(cat.questions||[]).length} q)`;
        btn.onclick = () => {
            container.classList.add('hidden');
            selectCategory(idx);
        };
        container.appendChild(btn);
    });
}

function selectCategory(idx){
    gameState.q3selectedCategory = idx;
    gameState.q3categoryProgress = 0;
    gameState.q3categoryCorrectCount = 0;
    $('buzzerBtn').disabled = false;
    $('answerInput').disabled = true;
    $('questionText').textContent = `Category: ${QUESTIONS.q3[idx].category} ‚Äî press Next Question to begin`;
    // Immediately start reading the first question in that category:
    nextQuestion();
}

/* ------------------ Reading / typing effect ------------------ */
function startReading(){
    clearAllTimers();
    gameState.buzzed = false;
    gameState.multiplier = 1;
    updateScoreDisplays();
    clearFeedback();

    let questionText = "";
    let correctAnswer = "";
    gameState.currentBonus = null;

    if (gameState.currentQuarter === 1){
        const q = gameState.activeQ1[gameState.currentQuestionIndex];
        questionText = q ? q.question : "";
        correctAnswer = q ? q.answer : "";
    } else if (gameState.currentQuarter === 2){
        const q = gameState.activeQ2[gameState.currentQuestionIndex];
        questionText = q ? q.tossup.question : "";
        correctAnswer = q ? q.tossup.answer : "";
        gameState.currentBonus = q ? q.bonus : null;
    } else if (gameState.currentQuarter === 3){
        const cat = gameState.activeQ3[gameState.q3selectedCategory];
        const qIndex = gameState.q3categoryProgress;
        const q = cat && cat.questions ? cat.questions[qIndex] : null;
        questionText = q ? q.question : "";
        correctAnswer = q ? q.answer : "";
    } else if (gameState.currentQuarter === 4){
        const q = gameState.activeQ4[gameState.currentQuestionIndex];
        if (!q) { questionText = ""; correctAnswer = ""; }
        else {
            gameState.currentQ4Parts = q.parts;
            gameState.q4partIndex = 0;
            correctAnswer = q.answer;
            // Start reading first part
            readQ4Part();
        }
    }

    gameState.currentQuestionText = questionText;
    gameState.currentAnswer = correctAnswer;
    gameState.readingCharIndex = 0;
    $('questionText').textContent = "";
    $('timerDisplay').textContent = "--";

    gameState.readingInterval = setInterval(()=>{
        if (gameState.readingCharIndex < questionText.length && !gameState.buzzed){
            $('questionText').textContent += questionText[gameState.readingCharIndex];
            gameState.readingCharIndex++;
        } else {
            clearInterval(gameState.readingInterval);
            gameState.readingInterval = null;
            if (!gameState.buzzed){
                let postReadTime = 5;
                $('timerDisplay').textContent = `Buzz: ${postReadTime}`;
                gameState.postReadTimer = setInterval(()=>{
                    postReadTime--;
                    $('timerDisplay').textContent = `Buzz: ${postReadTime}`;
                    if (postReadTime <= 0){
                        clearInterval(gameState.postReadTimer);
                        $('buzzerBtn').disabled = true;
                        $('timerDisplay').textContent = "--";
                    }
                },1000);
            }
        }
    }, 30);
}



/* ------------------ Buzz logic ------------------ */
function buzz(){
    // Single-team mode: buzz just stops reading and allows player to answer
    if (gameState.buzzed) return;
    gameState.buzzed = true;
    gameState.lastActionTimestamp = Date.now();

    // Stop reading animation at the buzz point (don‚Äôt auto-reveal rest)
    if (gameState.readingInterval){
        clearInterval(gameState.readingInterval);
        gameState.readingInterval = null;
    }

    // Calculate multiplier based on where they buzzed (how much was read)
    let pctRead = 1;
    if (gameState.currentQuestionText && gameState.readingCharIndex){
        pctRead = gameState.readingCharIndex / gameState.currentQuestionText.length;
        if (pctRead < 0) pctRead = 0;
        if (pctRead > 1) pctRead = 1;
    } else {
        pctRead = 1;
    }

    if (pctRead < 0.15) gameState.multiplier = 5;
    else if (pctRead < 0.35) gameState.multiplier = 4;
    else if (pctRead < 0.55) gameState.multiplier = 3;
    else if (pctRead < 0.8) gameState.multiplier = 2;
    else gameState.multiplier = 1;

    // Enable answer input
    $('answerInput').disabled = false;
    $('answerInput').focus();
    $('buzzerBtn').disabled = true;
    updateScoreDisplays();
    
    // Start 10s answer timer
    let timeLeft = 10;
    $('timerDisplay').textContent = `Answer: ${timeLeft}`;
    gameState.answerTimer = setInterval(()=>{
       timeLeft--;
       $('timerDisplay').textContent = `Answer: ${timeLeft}`;
       if (timeLeft <= 0){
          clearInterval(gameState.answerTimer);
          $('answerInput').disabled = true;
          $('timerDisplay').textContent = "--";
          setFeedback("Time expired! No points awarded.", false);
          setTimeout(()=>{ incrementQuestionIndex(); nextQuestion(); }, 900);
        }
    },1000);


    // Start 10-second timer to answer
    let buzzTime = 10;
    $('timerDisplay').textContent = `Answer Time: ${buzzTime}`;
    gameState.buzzTimer = setInterval(()=>{
        buzzTime--;
        $('timerDisplay').textContent = `Answer Time: ${buzzTime}`;
        if (buzzTime <= 0){
            clearInterval(gameState.buzzTimer);
            gameState.buzzTimer = null;
            $('answerInput').disabled = true;
            $('submitBtn').disabled = true;
            $('timerDisplay').textContent = "Time expired.";
            // Show correct answer (no points)
            alert(`‚è∞ Time up! The correct answer was: ${gameState.currentAnswer}`);
        }
    },1000);
}

/* ------------------ Show answer (for practice) ------------------ */
function showAnswer(){
    if (!gameState.currentAnswer) {
        setFeedback("No current answer available.", false);
        return;
    }
    $('questionText').textContent = gameState.currentQuestionText || '---';
    setFeedback(`Answer: ${gameState.currentAnswer}`, true);
}

/* ------------------ Answer checking & scoring ------------------ */
function normalize(s){
    return (s || "").toString().trim().toLowerCase().replace(/[^\w\s]/g,'');
}

function submitAnswer(){
    if ($('answerInput').disabled) return;

    const given = $('answerInput').value.trim();
    if (!given){
        setFeedback("Please type an answer before submitting.", false);
        return;
    }

    // lock immediately so multiple clicks can‚Äôt resubmit
    $('answerInput').disabled = true;
    $('submitBtn').disabled = true;
    if (gameState.buzzTimer){
        clearInterval(gameState.buzzTimer);
        gameState.buzzTimer = null;
    }
    $('timerDisplay').textContent = "";

    const playerAnswer = normalize(given);
    const correct = normalize(gameState.currentAnswer);
    const isCorrect = playerAnswer === correct || correct.includes(playerAnswer) 

    // Base points and behavior depends on quarter
    let basePoints = 0;
    let earnedWeighted = 0;
    let earnedRaw = 0;
    let txtFeedback = "";

    if (gameState.currentQuarter === 1){
        basePoints = 10;
        if (isCorrect){
            earnedRaw = basePoints;
            earnedWeighted = Math.round(earnedRaw * gameState.multiplier);
            txtFeedback = `Correct! +${earnedRaw} raw (√ó${gameState.multiplier}) = +${earnedWeighted} weighted`;
            // auto-advance scores
            gameState.rawScore += earnedRaw;
            gameState.weightedScore += earnedWeighted;
            updateScoreDisplays();
            setFeedback(txtFeedback, true);
            // move to next question after a brief delay
            setTimeout(()=> {
                incrementQuestionIndex();
                nextQuestion();
            }, 900);
        } else {
            setFeedback("Incorrect. No deduction (per rules).", false);
            // in single-team practice, we just move to next question
            setTimeout(()=> {
                incrementQuestionIndex();
                nextQuestion();
            }, 900);
        }
    } else if (gameState.currentQuarter === 2){
        basePoints = 10;
        if (isCorrect){
            earnedRaw = basePoints;
            earnedWeighted = Math.round(earnedRaw * gameState.multiplier);
            gameState.rawScore += earnedRaw;
            gameState.weightedScore += earnedWeighted;
            updateScoreDisplays();
            setFeedback(`Correct tossup! ${earnedRaw} raw, ${earnedWeighted} weighted. Now: bonus question.`, true);
            // Show bonus question (if present)
            if (gameState.currentBonus){
                // show bonus text, disable buzzer, enable answer for bonus with standard multiplier of 1
                $('questionText').textContent = gameState.currentBonus.question;
                gameState.currentAnswer = gameState.currentBonus.answer;
                gameState.multiplier = 1; // bonuses not multiplied by buzz timing in this implementation
                $('multiplierDisplay').textContent = `Multiplier: √ó${gameState.multiplier}`;
                // keep answer input enabled (player types bonus answer)
                // Mark the tossup as answered, but we won't advance past the bonus until they submit it
            } else {
                // no bonus; continue
                setTimeout(()=> {
                    incrementQuestionIndex();
                    nextQuestion();
                }, 900);
            }
        } else {
            setFeedback("Incorrect tossup. No deduction. (No bonus.)", false);
            // advance to next question
            setTimeout(()=> {
                incrementQuestionIndex();
                nextQuestion();
            }, 900);
        }
    } else if (gameState.currentQuarter === 3){
        // category round: questions are sequential within a category
        basePoints = 10;
        if (isCorrect){
            earnedRaw = basePoints;
            earnedWeighted = Math.round(earnedRaw * gameState.multiplier);
            gameState.rawScore += earnedRaw;
            gameState.weightedScore += earnedWeighted;
            gameState.q3categoryCorrectCount++;
            updateScoreDisplays();
            setFeedback(`Correct for category: +${earnedRaw} raw (${earnedWeighted} weighted).`, true);
            // increment progress and go to next within same category
            incrementQuestionIndex();
            setTimeout(()=> {
                nextQuestion();
            }, 700);
        } else {
            setFeedback("Incorrect. No deduction. (You may continue with remaining category questions.)", false);
            incrementQuestionIndex();
            setTimeout(()=> {
                nextQuestion();
            }, 700);
        }
    } else if (gameState.currentQuarter === 4){
        // Use part index for scoring
        let bracketPoints = 10;
        if (gameState.q4partIndex === 0) bracketPoints = 30;
        else if (gameState.q4partIndex === 1) bracketPoints = 20;
        else bracketPoints = 10;
    
        basePoints = bracketPoints;
        if (isCorrect){
            earnedRaw = basePoints;
            earnedWeighted = Math.round(earnedRaw * gameState.multiplier);
            gameState.rawScore += earnedRaw;
            gameState.weightedScore += earnedWeighted;
            updateScoreDisplays();
            setFeedback(`Correct! +${earnedRaw} raw (${earnedWeighted} weighted).`, true);
            incrementQuestionIndex();
            setTimeout(()=> nextQuestion(), 900);
        } else {
            setFeedback("Incorrect. No deduction.", false);
            incrementQuestionIndex();
            setTimeout(()=> nextQuestion(), 900);
        }
    }

    // Special: if we just answered a Q2 bonus (we set currentQuestionText to bonus question and currentAnswer became bonus answer)
    // We need to detect whether the last submit was a bonus (we detect by presence of 'currentBonus' and whether we're currently showing its question)
    if (gameState.currentQuarter === 2 && gameState.currentBonus && $('questionText').textContent === gameState.currentBonus.question){
        // This submit is for the bonus
        const bonusIsCorrect = isCorrect;
        if (bonusIsCorrect){
            const bn = 10;
            gameState.rawScore += bn;
            gameState.weightedScore += Math.round(bn * gameState.multiplier); // multiplier is 1 for bonus by default
            updateScoreDisplays();
            setFeedback(`Correct bonus! +${bn} raw.`, true);
        } else {
            setFeedback(`Incorrect bonus. No deduction.`, false);
        }
        // clear bonus and advance
        gameState.currentBonus = null;
        setTimeout(()=> {
            incrementQuestionIndex();
            nextQuestion();
        }, 900);
    }
}

/* ------------------ Utility: compute question counter text ------------------ */
function computeQuestionCounterText(){
    // Rough indicator per quarter
    const q = gameState.currentQuarter;
    if (q === 1) return `Q ${Math.max(0, gameState.currentQuestionIndex+1)} / ${QUESTIONS.q1.length}`;
    if (q === 2) return `Q ${Math.max(0, gameState.currentQuestionIndex+1)} / ${QUESTIONS.q2.length}`;
    if (q === 3){
        if (gameState.q3selectedCategory !== null){
            const cat = QUESTIONS.q3[gameState.q3selectedCategory];
            return `Category ${cat.category} ‚Äî Q ${gameState.q3categoryProgress+1} / ${cat.questions.length}`;
        }
        return `Select category`;
    }
    if (q === 4) return `Q ${Math.max(0, gameState.currentQuestionIndex+1)} / ${QUESTIONS.q4.length}`;
    return '';
}

/* ------------------ Finish/End-game ------------------ */
function finishGame(){
    clearAllTimers();
    // Finalize: show totals and offer to save to local leaderboard
    const raw = gameState.rawScore;
    const weighted = gameState.weightedScore;
    const roundedWeighted = Math.round(weighted / 10) * 10; // round to nearest 10 per request

    // Save to local leaderboard
    const entry = {
        date: (new Date()).toISOString(),
        mode: gameState.mode,
        rawScore: raw,
        weightedScore: weighted,
        roundedWeighted: roundedWeighted
    };
    saveScoreToLocalLeaderboard(entry);

    $('questionText').textContent = `Game finished! Raw: ${raw} / Weighted: ${weighted} (rounded ${roundedWeighted}). Saved to local leaderboard.`;
    setFeedback("Game complete ‚Äî check the leaderboard from the menu.", true);
    $('buzzerBtn').disabled = true;
    $('answerInput').disabled = true;
}

/* Save to local leaderboard (localStorage) */
function saveScoreToLocalLeaderboard(entry){
    const key = 'hb_local_leaderboard_v1';
    const existing = JSON.parse(localStorage.getItem(key) || '[]');
    existing.push(entry);
    // Sort by weightedScore descending (then raw as tiebreak)
    existing.sort((a,b)=> (b.weightedScore - a.weightedScore) || (b.rawScore - a.rawScore));
    localStorage.setItem(key, JSON.stringify(existing));
}

/* Render leaderboard */
function renderLeaderboard(){
    const key = 'hb_local_leaderboard_v1';
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    const container = $('leaderboardList');
    container.innerHTML = '';
    if (!arr.length){
        container.textContent = 'No saved attempts yet.';
        return;
    }
    // show all attempts
    arr.forEach((e, idx) => {
        const d = document.createElement('div');
        d.style.padding = '8px';
        d.style.borderBottom = '1px solid #eef2f7';
        d.innerHTML = `<strong>#${idx+1}</strong> ‚Äî ${new Date(e.date).toLocaleString()} ‚Äî Mode: ${e.mode} ‚Äî Raw: ${e.rawScore} ‚Äî Weighted: ${e.weightedScore} (rounded ${e.roundedWeighted})`;
        container.appendChild(d);
    });
}

/* Clear leaderboard */
function clearLeaderboard(){
    if (!confirm("Clear all local leaderboard entries? This cannot be undone.")) return;
    localStorage.removeItem('hb_local_leaderboard_v1');
    renderLeaderboard();
}

/* ------------------ Import/Export Questions (quick JSON) ------------------ */
function exportQuestions(){
    const asText = JSON.stringify(QUESTIONS, null, 2);
    // Simple download as file
    const blob = new Blob([asText], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'hb_questions_export.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

function importQuestions(){
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,application/json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const obj = JSON.parse(ev.target.result);
                // Quick validation
                if (!obj.q1 || !obj.q2 || !obj.q3 || !obj.q4) {
                    alert("JSON doesn't look like the expected QUESTIONS structure.");
                    return;
                }
                // Overwrite in-memory QUESTIONS object (not the file content)
                QUESTIONS.q1 = obj.q1;
                QUESTIONS.q2 = obj.q2;
                QUESTIONS.q3 = obj.q3;
                QUESTIONS.q4 = obj.q4;
                alert("Imported QUESTIONS into memory for this session. To make permanent changes, edit the HTML file's QUESTIONS section.");
                renderQuestionsDisplay();
            } catch (err) {
                alert("Failed to parse JSON: " + err.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

/* Render a simple questions display */
function renderQuestionsDisplay(){
    const container = $('questionsDisplay');
    container.innerHTML = '';
    const pre = document.createElement('pre');
    pre.style.whiteSpace = 'pre-wrap';
    pre.style.fontSize = '13px';
    pre.textContent = JSON.stringify(QUESTIONS, null, 2);
    container.appendChild(pre);
}

/* ------------------ Key handling (Enter to submit) ------------------ */
document.addEventListener('keydown', function(e){
    if (e.key === 'Enter'){
        if (!$('answerInput').disabled && document.activeElement === $('answerInput')){
            submitAnswer();
        }
    }
});

/* ------------------ Page init ------------------ */
function init(){
    resetGame();
    // display any leaderboard counts on the menu? optional
    renderQuestionsDisplay();
    updateScoreDisplays();
}

init();

/* ------------------ Final notes for hosting global leaderboard -----------
If you host this on a website and want a GLOBAL leaderboard:
 - Create a small backend (Firebase/Firestore or a tiny Node + DB).
 - On finishGame(), send `entry` via fetch() to your endpoint.
 - Endpoint stores entry and returns a global top-N list.
 - Replace localStorage saving with a successful POST response.

This file is intentionally single-file and local-only by default.
--------------------------------------------------------------------------- */
</script>
</body>
</html>
