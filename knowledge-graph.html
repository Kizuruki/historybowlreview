<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Knowledge Graph Study</title>
  <style>
    .node-card {
      border: 2px solid #5a67d8;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      background: white;
    }
    
    .star-display {
      font-size: 24px;
      margin: 8px 0;
    }
    
    .star.earned { color: gold; }
    .star.platinum { color: #00d4ff; animation: shimmer 1.5s infinite; }
    .star.empty { color: #ccc; }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .related-nodes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    .mini-node {
      padding: 12px;
      border-radius: 8px;
      background: #f3f4f6;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mini-node:hover {
      background: #e5e7eb;
      transform: translateY(-2px);
    }
    
    .division-filter {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      background: white;
      cursor: pointer;
    }
    
    .filter-btn.active {
      background: #5a67d8;
      color: white;
      border-color: #5a67d8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Knowledge Graph Study</h1>
    
    <!-- Division filters -->
    <div class="division-filter" id="divisionFilters"></div>
    
    <!-- Progress overview -->
    <div id="progressOverview"></div>
    
    <!-- Current node being studied -->
    <div id="currentNodeView"></div>
    
    <!-- Related nodes -->
    <div id="relatedNodes" class="related-nodes"></div>
    
    <!-- Practice questions for this node -->
    <div id="nodePractice"></div>
  </div>

  <script type="module">
    // Load the graph data
    let nodesData = [];
    let graphData = {};
    let currentNode = null;
    let userProgress = {}; // Will store in localStorage
  
    async function init() {
      // Load the generated JSON files
      const [nodesRes, graphRes] = await Promise.all([
        fetch('output_nodes.json'),
        fetch('output_graph.json')
      ]);
      
      nodesData = await nodesRes.json();
      graphData = await graphRes.json();
      
      // Load user progress from localStorage
      const saved = localStorage.getItem('kg_progress');
      if (saved) userProgress = JSON.parse(saved);
      
      renderDivisionFilters();
      renderProgressOverview();
    }
    
    function renderDivisionFilters() {
      const categories = [...new Set(nodesData.map(n => n.category))].sort();
      
      const container = document.getElementById('divisionFilters');
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = cat;
        btn.onclick = () => filterByCategory(cat);
        container.appendChild(btn);
      });
    }
    
    function filterByCategory(category) {
      const filtered = nodesData.filter(n => n.category === category);
      renderNodeList(filtered);
    }
    
    function renderNodeList(nodes) {
      const container = document.getElementById('progressOverview');
      container.innerHTML = '<h3>Select a Node:</h3>';
      
      nodes.forEach(node => {
        const div = document.createElement('div');
        div.className = 'mini-node';
        div.textContent = node.answer;
        div.onclick = () => selectNode(node.answer);
        container.appendChild(div);
      });
    }
    
    function renderProgressOverview() {
      const total = nodesData.length;
      const completed = Object.values(userProgress).filter(p => p.stars >= 1).length;
      
      document.getElementById('progressOverview').innerHTML = `
        <p>Progress: ${completed}/${total} nodes explored</p>
      `;
    }
    
    function selectNode(nodeAnswer) {
      currentNode = nodesData.find(n => n.answer === nodeAnswer);
      if (!currentNode) return;
      
      const progress = userProgress[nodeAnswer] || { stars: 0, platinum_until: null, times_correct: 0, times_wrong: 0 };
      
      renderCurrentNode(currentNode, progress);
      renderRelatedNodes(nodeAnswer);
    }
    
    function renderCurrentNode(node, progress) {
      const view = document.getElementById('currentNodeView');
      view.innerHTML = `
        <div class="node-card active">
          <h2>${node.answer}</h2>
          <div class="star-display">${getStarDisplay(progress.stars, progress.platinum_until)}</div>
          
          <p><strong>Category:</strong> ${node.category}</p>
          <p><strong>Questions about this:</strong> ${node.questions.length}</p>
          
          <div class="summary">
            ${node.questions.slice(0, 2).map(q => `<p class="small">• ${q.substring(0, 100)}...</p>`).join('')}
          </div>
          
          <button class="btn" onclick="startNodePractice()">
            Practice ${node.questions.length} Questions
          </button>
        </div>
      `;
    }
    
    function getStarDisplay(stars, platinumUntil) {
      const isPlatinum = platinumUntil && Date.now() < platinumUntil;
      const starClass = isPlatinum ? 'platinum' : 'earned';
      
      let html = '';
      for (let i = 0; i < 3; i++) {
        if (i < stars) {
          html += `<span class="star ${starClass}">★</span>`;
        } else {
          html += `<span class="star empty">☆</span>`;
        }
      }
      return html;
    }
    
    function renderRelatedNodes(nodeAnswer) {
      const connections = graphData[nodeAnswer]?.connections || [];
      const container = document.getElementById('relatedNodes');
      
      container.innerHTML = '<h3>Related Nodes:</h3>';
      
      connections.forEach(relatedAnswer => {
        const relatedNode = nodesData.find(n => n.answer === relatedAnswer);
        if (!relatedNode) return;
        
        const score = graphData[nodeAnswer].scores[relatedAnswer];
        
        const div = document.createElement('div');
        div.className = 'mini-node';
        div.innerHTML = `
          <strong>${relatedNode.answer}</strong><br>
          <small>Similarity: ${(score * 100).toFixed(0)}%</small>
        `;
        div.onclick = () => selectNode(relatedAnswer);
        container.appendChild(div);
      });
    }
    
    window.startNodePractice = function() {
      if (!currentNode) return;
      
      // Store questions for practice
      localStorage.setItem('practice_questions', JSON.stringify(currentNode.questions));
      localStorage.setItem('practice_node', currentNode.answer);
      
      alert(`Starting practice with ${currentNode.questions.length} questions about ${currentNode.answer}`);
      // You can redirect to your main practice page here or implement inline practice
    }
    
    init();
  </script>
</body>
</html>
