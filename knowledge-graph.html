<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Knowledge Graph Study</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #5a67d8;
      text-align: center;
      margin-bottom: 20px;
      font-size: 2.2rem;
    }
    
    .layout {
      display: grid;
      grid-template-columns: 250px 1fr 300px;
      gap: 20px;
      margin-top: 20px;
    }
    
    /* Left sidebar - categories */
    .sidebar-left {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .sidebar-left h3 {
      color: #5a67d8;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    
    .category-item {
      padding: 12px;
      margin: 8px 0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .category-item:hover {
      border-color: #5a67d8;
      transform: translateX(5px);
    }
    
    .category-item.active {
      background: #5a67d8;
      color: white;
    }
    
    /* Center - graph canvas */
    .graph-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      position: relative;
      min-height: 600px;
      border: 2px solid #e2e8f0;
    }
    
    #graphCanvas {
      width: 100%;
      height: 600px;
    }
    
    .node-circle {
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .node-circle:hover {
      stroke-width: 4px;
      filter: drop-shadow(0 0 8px rgba(90, 103, 216, 0.6));
    }
    
    .node-circle.center {
      stroke: #5a67d8;
      stroke-width: 4px;
      fill: #667eea;
    }
    
    .node-circle.connected {
      fill: #48bb78;
      stroke: #38a169;
      stroke-width: 2px;
    }
    
    .node-circle.second-degree {
      fill: #ed8936;
      stroke: #dd6b20;
      stroke-width: 1px;
    }
    
    .node-label {
      font-size: 12px;
      font-weight: 600;
      pointer-events: none;
      text-anchor: middle;
    }
    
    .connection-line {
      stroke: #cbd5e0;
      stroke-width: 2px;
      opacity: 0.6;
    }
    
    .connection-line.strong {
      stroke: #5a67d8;
      stroke-width: 3px;
      opacity: 0.8;
    }
    
    /* Right sidebar - node details */
    .sidebar-right {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .node-details h2 {
      color: #5a67d8;
      font-size: 1.5rem;
      margin-bottom: 10px;
    }
    
    .star-display {
      font-size: 24px;
      margin: 10px 0;
    }
    
    .star.earned { color: gold; }
    .star.platinum { 
      color: #00d4ff; 
      animation: shimmer 1.5s infinite;
      text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
    }
    .star.empty { color: #cbd5e0; }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .node-info {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .node-info p {
      margin: 8px 0;
      color: #4a5568;
    }
    
    .question-preview {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9rem;
      border-left: 4px solid #5a67d8;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      width: 100%;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    .related-list {
      margin-top: 20px;
    }
    
    .related-item {
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .related-item:hover {
      border-color: #5a67d8;
      transform: translateX(5px);
    }
    
    .similarity-badge {
      display: inline-block;
      background: #e6fffa;
      color: #047857;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 5px;
    }
    
    /* Practice modal */
    .practice-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .practice-modal.active {
      display: flex;
    }
    
    .practice-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .practice-question {
      font-size: 1.1rem;
      line-height: 1.6;
      margin: 20px 0;
      color: #2d3748;
    }
    
    .practice-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      margin: 15px 0;
    }
    
    .practice-input:focus {
      outline: none;
      border-color: #5a67d8;
    }
    
    .practice-feedback {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 600;
    }
    
    .practice-feedback.correct {
      background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
      color: #22543d;
    }
    
    .practice-feedback.incorrect {
      background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
      color: #742a2a;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn.secondary {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåê History Knowledge Graph</h1>
    
    <div class="layout">
      <!-- Left Sidebar: Categories -->
      <div class="sidebar-left">
        <h3>üìö Categories</h3>
        <div id="categoryList"></div>
        
        <h3 style="margin-top: 20px;">üìä Progress</h3>
        <div id="progressStats"></div>
      </div>
      
      <!-- Center: Graph Visualization -->
      <div class="graph-container">
        <svg id="graphCanvas"></svg>
      </div>
      
      <!-- Right Sidebar: Node Details -->
      <div class="sidebar-right">
        <div id="nodeDetails">
          <p style="color: #718096; text-align: center; margin-top: 100px;">
            Select a category and click on a node to view details
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Practice Modal -->
  <div class="practice-modal" id="practiceModal">
    <div class="practice-content">
      <h2 style="color: #5a67d8; margin-bottom: 20px;">Practice Questions</h2>
      <div id="practiceArea"></div>
    </div>
  </div>

  <script type="module">
    // Load the graph data
    let nodesData = [];
    let graphData = {};
    let currentNode = null;
    let userProgress = {}; // Will store in localStorage
  
    async function init() {
      // Load the generated JSON files
      const [nodesRes, graphRes] = await Promise.all([
        fetch('graph_data/output_nodes.json'),  // Changed
        fetch('graph_data/output_graph.json')   // Changed
      ]);
      
      nodesData = await nodesRes.json();
      graphData = await graphRes.json();
      
      // Load user progress from localStorage
      const saved = localStorage.getItem('kg_progress');
      if (saved) userProgress = JSON.parse(saved);
      
      renderDivisionFilters();
      renderProgressOverview();
    }
    
    function renderDivisionFilters() {
      const categories = [...new Set(nodesData.map(n => n.category))].sort();
      
      const container = document.getElementById('divisionFilters');
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = cat;
        btn.onclick = () => filterByCategory(cat);
        container.appendChild(btn);
      });
    }
    
    function filterByCategory(category) {
      const filtered = nodesData.filter(n => n.category === category);
      renderNodeList(filtered);
    }
    
    function renderNodeList(nodes) {
      const container = document.getElementById('progressOverview');
      container.innerHTML = '<h3>Select a Node:</h3>';
      
      nodes.forEach(node => {
        const div = document.createElement('div');
        div.className = 'mini-node';
        div.textContent = node.answer;
        div.onclick = () => selectNode(node.answer);
        container.appendChild(div);
      });
    }
    
    function renderProgressOverview() {
      const total = nodesData.length;
      const completed = Object.values(userProgress).filter(p => p.stars >= 1).length;
      
      document.getElementById('progressOverview').innerHTML = `
        <p>Progress: ${completed}/${total} nodes explored</p>
      `;
    }
    
    function selectNode(nodeAnswer) {
      currentNode = nodesData.find(n => n.answer === nodeAnswer);
      if (!currentNode) return;
      
      const progress = userProgress[nodeAnswer] || { stars: 0, platinum_until: null, times_correct: 0, times_wrong: 0 };
      
      renderCurrentNode(currentNode, progress);
      renderRelatedNodes(nodeAnswer);
    }
    
    function renderCurrentNode(node, progress) {
      const view = document.getElementById('currentNodeView');
      view.innerHTML = `
        <div class="node-card active">
          <h2>${node.answer}</h2>
          <div class="star-display">${getStarDisplay(progress.stars, progress.platinum_until)}</div>
          
          <p><strong>Category:</strong> ${node.category}</p>
          <p><strong>Questions about this:</strong> ${node.questions.length}</p>
          
          <div class="summary">
            ${node.questions.slice(0, 2).map(q => `<p class="small">‚Ä¢ ${q.substring(0, 100)}...</p>`).join('')}
          </div>
          
          <button class="btn" onclick="startNodePractice()">
            Practice ${node.questions.length} Questions
          </button>
        </div>
      `;
    }
    
    function getStarDisplay(stars, platinumUntil) {
      const isPlatinum = platinumUntil && Date.now() < platinumUntil;
      const starClass = isPlatinum ? 'platinum' : 'earned';
      
      let html = '';
      for (let i = 0; i < 3; i++) {
        if (i < stars) {
          html += `<span class="star ${starClass}">‚òÖ</span>`;
        } else {
          html += `<span class="star empty">‚òÜ</span>`;
        }
      }
      return html;
    }
    
    function renderRelatedNodes(nodeAnswer) {
      const connections = graphData[nodeAnswer]?.connections || [];
      const container = document.getElementById('relatedNodes');
      
      container.innerHTML = '<h3>Related Nodes:</h3>';
      
      connections.forEach(relatedAnswer => {
        const relatedNode = nodesData.find(n => n.answer === relatedAnswer);
        if (!relatedNode) return;
        
        const score = graphData[nodeAnswer].scores[relatedAnswer];
        
        const div = document.createElement('div');
        div.className = 'mini-node';
        div.innerHTML = `
          <strong>${relatedNode.answer}</strong><br>
          <small>Similarity: ${(score * 100).toFixed(0)}%</small>
        `;
        div.onclick = () => selectNode(relatedAnswer);
        container.appendChild(div);
      });
    }
    
    window.startNodePractice = function() {
      if (!currentNode) return;
      
      // Store questions for practice
      localStorage.setItem('practice_questions', JSON.stringify(currentNode.questions));
      localStorage.setItem('practice_node', currentNode.answer);
      
      alert(`Starting practice with ${currentNode.questions.length} questions about ${currentNode.answer}`);
      // You can redirect to your main practice page here or implement inline practice
    }
    
    init();
  </script>
</body>
</html>
